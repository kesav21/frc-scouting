#!/bin/env python

import json
import requests
import argparse


def main():

    # configuration
    args = get_arguments()
    api_key = get_api_key("config.json")

    # get data
    endpoints = get_endpoints(args)
    urls = get_urls(api_key, endpoints)
    events = get_events(urls)
    events = filter_events(events)
    events = get_event_keys(events)

    # print data
    for event in events:
        print(event)


def get_event_keys(events):
    for event in events:
        yield event["key"]


def filter_events(events):
    for event in events:
        if event["event_type_string"] != "Offseason":
            yield event


def get_events(urls):
    for url in urls:
        yield from requests.get(url).json()


def get_urls(api_key, endpoints):
    for endpoint in endpoints:
        base_url = "https://www.thebluealliance.com/api/v3"
        url = f"{base_url}/{endpoint}?X-TBA-Auth-Key={api_key}"
        yield url


def get_endpoints(args):

    # given no team but year
    if args.team is None and args.year is not None:
        year = set(args.year)
        return (f"events/{y}" for y in year)

    # given team but no year
    if args.team is not None and args.year is None:
        team = set(args.team)
        return (f"team/frc{t}/events" for t in team)

    # given team and year
    if args.team is not None and args.year is not None:
        team = set(args.team)
        year = set(args.year)
        return (f"team/frc{t}/events/{y}" for y in year for t in team)


def get_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument("--team", "-t", nargs="*", type=int)
    parser.add_argument("--year", "-y", nargs="*", type=int)

    args = parser.parse_args()
    validate_args(parser, args)

    return args


def validate_args(parser, args):
    # given no arguments
    if args.team is None and args.year is None:
        parser.error("you must specify at least one argument")


def printj(data):
    print(json.dumps(data, indent=4))


def get_api_key(file):
    with open(file, "r") as f:
        return json.load(f)["api_key"]


if __name__ == "__main__":
    main()
